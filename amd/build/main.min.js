define(["jquery","core/modal_factory","core/modal_events","core/templates","core/notification","core/ajax"],function(e,t,a,n,o,i){var r=M.cfg.wwwroot,l=function(e,t){var a,n;for(var o in e)e.hasOwnProperty(o)&&(a=new RegExp("\\[\\["+o+"\\]\\]","g"),n=e[o]?e[o]:"",t=t.replace(a,n));return t};return{init:function(c,d){var f=e("#dataview-tpl-itemlist"),s=e("#dataview-tpl-itemsingle"),u=e(".dataview-board .records"),v=e("#dataview-tpl-createmessage"),h=null,p=null;e(".filter-box .one-filter").each(function(){var t=e(this);t.find(".filter-head").on("click",function(){t.toggleClass("opened")})}),t.create({body:v.html(),type:t.types.SAVE_CANCEL}).then(function(t){h=t,t.getModal().addClass("mod_dataview-message-modal"),t.setSaveButtonText(M.str.mod_dataview.goto),t.getRoot().on(a.save,function(){p&&e("<a>").prop({target:"_blank",href:p.attr("href")})[0].click()}),t.getRoot().on(a.hidden,function(){p=null})}),e(".filter-box .filter-btn").on("click",function(){var a=e("#fulltext-query").val(),v=[];e(".one-filter").each(function(){var t=e(this);t.find('input[type="checkbox"]:checked:enabled').each(function(){var t=e(this),a={key:t.attr("name"),value:t.val()};v.push(a)}),t.find("select").each(function(){var t=e(this);t.find("option:selected").each(function(){var a={key:t.attr("name"),value:e(this).val()};""!=a.value&&v.push(a)})}),t.find('input[type="text"]').each(function(){var t=e(this),a={key:t.attr("name"),value:t.val()};v.push(a)})}),u.empty().addClass("loading"),v.forEach(e=>{e.key=e.key.replace("f_",""),e.key=e.key.replace("[]","")}),i.call([{methodname:"mod_dataview_query",args:{id:c,q:a,filters:v},done:function(a){e(".dataview-board .records").removeClass("loading"),a.forEach(a=>{var o=JSON.parse(a),i=e(l(o,f.html()));i.find('[data-operation="viewdetail"]').on("click",function(){var a=e(this),i=a.data("modal");if(i)i.show();else{var c,f=s.html();""!=f.trim()?c=l(o,f):(o.wwwroot=r,o.cancreatetepuy=d,c=n.render("mod_dataview/detail",o).then(function(t,a){var n=e(t);return n.find('[data-operation="confirmgo"]').on("click",function(t){t.preventDefault(),p=e(this),h.show()}),n})),t.create({large:!0,body:c}).then(function(e){i=e,e.getModal().addClass("mod_dataview-record-modal"),e.show(),a.data("modal",i)})}}),u.append(i)})},fail:function(e){o.exception(e),console.log(e)}}])})}}});